From 042421e9e3d266ad0bb7805132041ef51ad3234d Mon Sep 17 00:00:00 2001
From: Adrian Johnson <ajohnson@redneon.com>
Date: Wed, 16 Aug 2017 22:52:35 -0400
Subject: [PATCH] cairo: Fix CVE-2017-9814

The bug happens because in some scenarios the variable size can
have a value of 0 at line 1288. And malloc(0) is not returning
NULL as some people could expect:

    https://stackoverflow.com/questions/1073157/zero-size-malloc

malloc(0) returns the smallest chunk possible. So the line 1290
with the return is not execute. And the execution continues with
an invalid map.

Since the size is 0 the variable map is not initialized correctly
at load_trutype_table. So, later when the variable map is accessed
previous values from a freed chunk are used. This could allows an
attacker to control the variable map.

This patch have not merge in upstream now.

Upstream-Status: Backport [https://bugs.freedesktop.org/show_bug.cgi?id=101547]
CVE: CVE-2017-9814
Signed-off-by: Dengke Du <dengke.du@windriver.com>
---
 src/cairo-truetype-subset.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/cairo-truetype-subset.c b/src/cairo-truetype-subset.c
index e3449a0..f77d11c 100644
--- a/src/cairo-truetype-subset.c
+++ b/src/cairo-truetype-subset.c
@@ -1285,7 +1285,7 @@ _cairo_truetype_reverse_cmap (cairo_scaled_font_t *scaled_font,
 	return CAIRO_INT_STATUS_UNSUPPORTED;
 
     size = be16_to_cpu (map->length);
-    map = malloc (size);
+    map = _cairo_malloc (size);
     if (unlikely (map == NULL))
 	return _cairo_error (CAIRO_STATUS_NO_MEMORY);
 
-- 
2.8.1

